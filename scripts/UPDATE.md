# Инструкция по обновлению и откату

## Процесс разработки и обновления

### 1. Разработка на деве

```bash
# На деве - работаете в ветке dev
git checkout dev
# ... делаете изменения ...
git add .
git commit -m "Описание изменений"
git push origin dev
```

### 2. Тестирование на деве

```bash
# На деве - тестируете изменения
# Если всё ок - мерджим в main
git checkout main
git merge dev
git push origin main
```

### 3. Обновление на проде

```bash
# На проде - запускаете скрипт обновления
cd ~/ce-guests-back
./scripts/update.sh
```

Скрипт автоматически:
- ✅ Проверит что вы на ветке main
- ✅ Создаст бэкап БД (с метаданными о коммите)
- ✅ Обновит код (`git pull`)
- ✅ Применит миграции (если есть)
- ✅ Перезапустит сервис
- ✅ Проверит здоровье сервиса
- ✅ Покажет команды для отката (если что-то пойдет не так)

## Откат при проблемах

Если что-то пошло не так после обновления:

```bash
# Автоматический откат на коммит из последнего бэкапа
./scripts/rollback.sh
```

Скрипт отката:
- ✅ Найдет последний бэкап БД
- ✅ Проверит идемпотентность (не откатит дважды на один коммит)
- ✅ Откатит код на коммит из бэкапа
- ✅ Восстановит БД из бэкапа
- ✅ Откатит миграции (если нужно)
- ✅ Перезапустит сервис
- ✅ Проверит здоровье

**Важно:** Скрипт проверяет что вы не откатываетесь на тот же коммит дважды (идемпотентность).

## Бэкапы БД

Бэкапы сохраняются в `backups/`:
- Перед каждым деплоем: `backup_YYYYMMDD_HHMMSS.db`
- Перед откатом: `rollback_backup_YYYYMMDD_HHMMSS.db`

Восстановление БД из бэкапа:
```bash
cp backups/backup_20260128_120000.db ce_guests.db
```

## Проверка статуса

```bash
# Статус сервиса
sudo systemctl status ce-guests-back

# Логи сервиса
sudo journalctl -u ce-guests-back -f

# Текущая версия миграций
alembic current

# Последние коммиты
git log --oneline -10
```
